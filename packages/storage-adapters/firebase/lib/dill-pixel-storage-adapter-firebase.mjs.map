{"version":3,"file":"dill-pixel-storage-adapter-firebase.mjs","sources":["../src/FirebaseAdapter.ts"],"sourcesContent":["import { IApplication, IStorageAdapter, Logger, StorageAdapter } from 'dill-pixel';\nimport type { FirebaseApp, FirebaseOptions } from 'firebase/app';\nimport { initializeApp } from 'firebase/app';\nimport type { DocumentData, Firestore, QueryConstraint } from 'firebase/firestore';\nimport {\n  addDoc,\n  collection,\n  deleteDoc,\n  doc,\n  getDoc,\n  getDocs,\n  getFirestore,\n  query,\n  setDoc,\n  where,\n} from 'firebase/firestore';\n\ninterface DocumentResult extends DocumentData {\n  id: string;\n\n  [key: string]: unknown;\n}\n\nconst defaultConfig: FirebaseOptions = {\n  apiKey: process.env.VITE_FIREBASE_API_KEY,\n  authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN,\n  projectId: process.env.VITE_FIREBASE_PROJECT_ID,\n  storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET,\n  messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID,\n  appId: process.env.VITE_FIREBASE_APP_ID,\n};\n\nexport interface IFirebaseAdapter extends IStorageAdapter {\n  db: Firestore;\n  firebaseApp: FirebaseApp;\n\n  initialize(app: IApplication, options?: Partial<FirebaseOptions>): void;\n\n  save<DocumentResult>(collectionName: string, data: DocumentData, id?: string): Promise<DocumentResult>;\n\n  getDocumentById(collectionName: string, id: string): Promise<DocumentResult | null>;\n\n  getDocumentWhere(collectionName: string, field: string, value: unknown): Promise<DocumentResult | null>;\n\n  getCollection(collectionName: string): Promise<DocumentResult[]>;\n\n  deleteDocumentById(collectionName: string, id: string): Promise<DocumentResult | null>;\n\n  deleteDocumentWhere(collectionName: string, field: string, value: unknown): Promise<DocumentResult | null>;\n\n  deleteCollection(collectionName: string): Promise<void>;\n\n  queryCollection(collectionName: string, ...queries: QueryConstraint[]): Promise<DocumentResult[]>;\n}\n\n/**\n * A class representing a storage adapter that uses Firebase.\n * @extends StorageAdapter\n */\nexport class FirebaseAdapter extends StorageAdapter implements IFirebaseAdapter {\n  private _options: FirebaseOptions;\n\n  private _firebaseApp: FirebaseApp;\n\n  /**\n   * Returns the Firebase app.\n   * @returns {FirebaseApp} The Firebase app.\n   */\n  get firebaseApp(): FirebaseApp {\n    return this._firebaseApp;\n  }\n\n  private _db: Firestore;\n\n  /**\n   * Returns the Firestore database.\n   * @returns {Firestore} The Firestore database.\n   */\n  get db() {\n    return this._db;\n  }\n\n  /**\n   * Initializes the adapter.\n   * @param {IApplication} _app The application that the adapter belongs to.\n   * @param {FirebaseOptions} options The options to initialize the adapter with.\n   * @returns {void}\n   */\n  public initialize(_app: IApplication, options: Partial<FirebaseOptions> = {}): void {\n    Logger.log('FirebaseAdapter initialized');\n\n    this._options = { ...defaultConfig, ...options };\n    this._firebaseApp = initializeApp(this._options);\n    this._db = getFirestore(this._firebaseApp); // initialize Firestore and get a reference to the database\n  }\n\n  /**\n   * Save or update a document in a collection.\n   * @param {string} collectionName The name of the collection.\n   * @param {DocumentData} data The data to save or update.\n   * @param {string} id The ID of the document to save or update, if applicable.\n   * @returns {Promise<DocumentResult>} The saved or updated document.\n   *\n   * @example\n   * await this.app.firebase.save('users', { username: 'relish', score: 50 }, 'custom-id');\n   */\n  async save<DocumentResult>(collectionName: string, data: DocumentData, id?: string): Promise<DocumentResult> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n\n    let docRef;\n    try {\n      if (id) {\n        docRef = doc(this.db, collectionName, id);\n      } else {\n        docRef = await addDoc(collection(this.db, collectionName), data);\n      }\n\n      // If the document does not exist, it will be created.\n      // If the document does exist, the data will be merged into the existing document.\n      await setDoc(docRef, data, { merge: true });\n\n      const docSnap = await getDoc(docRef);\n      return {\n        id: docSnap.id,\n        ...docSnap.data(),\n      } as DocumentResult;\n    } catch (error) {\n      throw new Error(`Error saving document: ${error}`);\n    }\n  }\n\n  /**\n   * Get a single document by its ID.\n   * @param {string} collectionName The name of the collection.\n   * @param {string} id The ID of the document to get.\n   * @returns {Promise<DocumentResult | null>} The document, or null if not found.\n   *\n   * @example\n   * await this.app.firebase.getDocumentById('users', 'custom-id');\n   */\n  async getDocumentById(collectionName: string, id: string): Promise<DocumentResult | null> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n    const docRef = doc(this.db, collectionName, id);\n\n    try {\n      const docSnap = await getDoc(docRef);\n\n      if (!docSnap.exists()) return null;\n\n      const data = {\n        id: docSnap.id,\n        ...docSnap.data(),\n      };\n\n      if (!data) return null;\n\n      return data;\n    } catch (error) {\n      throw new Error(`Error getting document: ${error}`);\n    }\n  }\n\n  /**\n   * Get a single document by a field value.\n   * @param {string} collectionName The name of the collection.\n   * @param {string} field The field to query.\n   * @param {unknown} value The value to query.\n   * @returns {Promise<DocumentResult | null>} The document, or null if not found.\n   *\n   * @example\n   * await this.app.firebase.getDocumentByField('users', 'username', 'relish');\n   */\n  async getDocumentWhere(collectionName: string, field: string, value: unknown): Promise<DocumentResult | null> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n\n    try {\n      const collectionRef = collection(this.db, collectionName);\n      const q = query(collectionRef, where(field, '==', value));\n      const querySnapshot = await getDocs(q);\n\n      if (!querySnapshot.empty) {\n        const doc = querySnapshot.docs[0];\n        return { id: doc.id, ...doc.data() };\n      } else {\n        return null;\n      }\n    } catch (error) {\n      throw new Error(`Error getting document: ${error}`);\n    }\n  }\n\n  /**\n   * Get all documents in a collection.\n   * @param {string} collectionName The name of the collection.\n   * @returns {Promise<DocumentResult[]>} An array of documents.\n   *\n   * @example\n   * await this.app.firebase.getCollection('users');\n   */\n  async getCollection(collectionName: string): Promise<DocumentResult[]> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n\n    try {\n      const collectionRef = collection(this.db, collectionName);\n      const querySnapshot = await getDocs(collectionRef);\n\n      const documents: DocumentResult[] = [];\n      querySnapshot.forEach((doc) => {\n        documents.push({ id: doc.id, ...doc.data() });\n      });\n\n      return documents;\n    } catch (error) {\n      throw new Error(`Error getting collection: ${error}`);\n    }\n  }\n\n  /**\n   * Delete a document by its ID.\n   * @param {string} collectionName The name of the collection.\n   * @param {string} id The ID of the document to delete.\n   * @returns {Promise<DocumentResult | null>} The deleted document, or null if not found.\n   *\n   * @example\n   * await this.app.firebase.deleteDocumentById('users', 'custom-id');\n   */\n  async deleteDocumentById(collectionName: string, id: string): Promise<DocumentResult | null> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n\n    try {\n      const docRef = doc(this.db, collectionName, id);\n      const docToDelete = await getDoc(docRef);\n\n      if (!docToDelete.exists()) {\n        return null;\n      }\n\n      await deleteDoc(docRef);\n      return {\n        id: docToDelete.id,\n        ...docToDelete.data(),\n      };\n    } catch (error) {\n      throw new Error(`Error deleting document: ${error}`);\n    }\n  }\n\n  /**\n   * Delete a document by a field value.\n   * @param {string} collectionName The name of the collection.\n   * @param {string} field The field to query.\n   * @param {unknown} value The value to query.\n   * @returns {Promise<DocumentResult | null>} The deleted document, or null if not found.\n   *\n   * @example\n   * await this.app.firebase.deleteDocumentByField('users', 'username', 'relish');\n   */\n  async deleteDocumentWhere(collectionName: string, field: string, value: unknown): Promise<DocumentResult | null> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n\n    try {\n      const docToDelete = await this.getDocumentWhere(collectionName, field, value);\n\n      if (!docToDelete) return null;\n\n      const docRef = doc(this.db, collectionName, docToDelete.id);\n      await deleteDoc(docRef);\n\n      return docToDelete;\n    } catch (error) {\n      throw new Error(`Error deleting document: ${error}`);\n    }\n  }\n\n  /**\n   * Delete all documents in a collection.\n   * @param {string} collectionName The name of the collection.\n   * @returns {Promise<void>} A promise that resolves when the operation is complete.\n   *\n   * @example\n   * await this.app.firebase.deleteCollection('users');\n   */\n  async deleteCollection(collectionName: string): Promise<void> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n\n    try {\n      const collectionRef = collection(this.db, collectionName);\n      const querySnapshot = await getDocs(collectionRef);\n\n      const docsToDelete: Promise<void>[] = [];\n      querySnapshot.forEach((doc) => {\n        docsToDelete.push(deleteDoc(doc.ref));\n      });\n\n      await Promise.all(docsToDelete);\n    } catch (error) {\n      throw new Error(`Error deleting collection: ${error}`);\n    }\n  }\n\n  /**\n   * Query a collection.\n   * @param {string} collectionName The name of the collection.\n   * @param {QueryConstraint[]} queries The query constraints to apply.\n   * @returns {Promise<DocumentResult[]>} An array of documents.\n   *\n   * @example\n   * await this.app.firebase.queryCollection('users', where('score', '>', 0), limit(10));\n   */\n  async queryCollection(collectionName: string, ...queries: QueryConstraint[]): Promise<DocumentResult[]> {\n    if (!this.db) {\n      throw new Error('Firestore has not been initialized. Call initialize() first.');\n    }\n\n    const documents: DocumentResult[] = [];\n    try {\n      const collectionRef = collection(this.db, collectionName);\n\n      const q = query(collectionRef, ...queries);\n\n      const querySnapshot = await getDocs(q);\n      querySnapshot.forEach((doc) => {\n        documents.push({ id: doc.id, ...doc.data() });\n      });\n\n      return documents;\n    } catch (error) {\n      throw new Error(`Error querying collection: ${error}`);\n    }\n  }\n}\n"],"names":["defaultConfig","FirebaseAdapter","StorageAdapter","_app","options","Logger","initializeApp","getFirestore","collectionName","data","id","docRef","doc","addDoc","collection","setDoc","docSnap","getDoc","error","field","value","collectionRef","q","query","where","querySnapshot","getDocs","documents","docToDelete","deleteDoc","docsToDelete","queries"],"mappings":"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"}